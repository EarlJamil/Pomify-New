<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout | Pomify</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      color: #222;
      font-family: 'Poppins', sans-serif;
    }
    .checkout-container {
      max-width: 800px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .price { font-weight: 600; color: #111; }
    .summary-box { background: #f5f5f5; border-radius: 12px; padding: 20px; margin-top: 20px; }
    .complete-btn { background: #1db954; color: white; font-weight: 600; width: 100%; border: none; border-radius: 30px; padding: 14px; margin-top: 20px; }
    .complete-btn:hover { background: #17a34a; }
    .payment-option { border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 10px; background: #fff; cursor: pointer; }
    .payment-option:hover { background: #f8f9fa; }
    .creator-box { background: #f5f5f5; border-radius: 12px; padding: 20px; margin-top: 20px; }
    .apply-btn { background: #007bff; color: white; border: none; border-radius: 8px; padding: 8px 16px; }
    .apply-btn:hover { background: #0056b3; }
    .duration-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .duration-btn {
      flex: 1; min-width: 120px; padding: 10px; border: 2px solid #ccc; border-radius: 10px; background: white; cursor: pointer; text-align: center; transition: 0.2s;
    }
    .duration-btn.active { border: 2px solid #1db954; color: #1db954; font-weight: 600; }
    .go-back { display: block; text-align: center; margin-top: 15px; color: gray; text-decoration: underline; cursor: pointer; }
    .go-back:hover { color: #555; }
    .small-muted { color: #6c757d; font-size: .9rem; }
    .next-billing { font-size: .9rem; color: #6c757d; margin-top: 8px; }
  </style>
</head>
<body>

  <div class="checkout-container">
    <h3 class="fw-bold mb-4">Checkout</h3>

    <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-3">
      <div>
        <h5 id="planName" class="mb-1 fw-semibold">[Name]</h5>
        <p id="planDescription" class="small-muted mb-1"></p>
        <p class="small-muted" id="nextBillingDisplay"></p>
        <p>Cancel anytime online.</p>
      </div>
      <h5 id="productPrice" class="price">â‚±299 / month</h5>
    </div>

    <!-- Duration area (shown only for Premium plans) -->
    <div id="durationContainer" class="d-none">
      <h6 class="fw-semibold mb-2">Choose plan duration</h6>
      <div class="duration-buttons" id="durationButtons"></div>
    </div>

    <h5 class="fw-semibold mb-3 mt-4">Payment method</h5>
    <div class="payment-option">
      <input type="radio" name="payment" id="gcash" checked>
      <label for="gcash" class="ms-2">GCash</label>
      <p class="text-muted small mb-0 ms-4">Click below to login and pay via your GCash account</p>
    </div>

    <div class="payment-option">
      <input type="radio" name="payment" id="shopee">
      <label for="shopee" class="ms-2">ShopeePay</label>
    </div>

    <div class="payment-option">
      <input type="radio" name="payment" id="card">
      <label for="card" class="ms-2">Credit or Debit Card</label>
    </div>

    <div class="payment-option">
      <input type="radio" name="payment" id="paypal">
      <label for="paypal" class="ms-2">PayPal</label>
    </div>

    <!-- Creator Code Section -->
    <div class="creator-box">
      <h6 class="fw-bold">Have a creator code?</h6>
      <div class="input-group mt-2">
        <input type="text" id="creatorCode" class="form-control" placeholder="Enter code">
        <button class="apply-btn" id="applyCodeBtn">Apply</button>
      </div>
      <small id="codeMessage" class="mt-2 d-block"></small>
    </div>

    <div class="summary-box">
      <h6 class="fw-bold">Summary</h6>
      <div class="d-flex justify-content-between">
        <p class="mb-0" id="summaryItem">Premium</p>
        <p class="mb-0 fw-semibold" id="summaryPrice"></p>
      </div>

      <!-- Base x months line (above discounts) -->
      <div id="baseTimes" class="mt-2 small-muted" style="display:none;">
        <!-- Filled by JS -->
      </div>

      <!-- Discount lines -->
      <div id="discountLine" class="d-none justify-content-between text-success small mt-2">
        <p class="mb-0" id="discountLabel">Discounts applied</p>
        <p class="mb-0" id="discountAmount"></p>
      </div>

      <hr>
      <div class="d-flex justify-content-between align-items-baseline">
        <p class="mb-0 fw-semibold">Total now</p>
        <p class="mb-0 fw-bold text-success" id="totalPrice"></p>
      </div>
    </div>

    <button class="complete-btn" id="completePurchaseBtn">Complete Purchase</button>
    <span class="go-back" id="goBackBtn">Go back to shop</span>
  </div>

<script>
  // ------- Helpers -------
  function formatCurrency(n) {
    return 'â‚±' + n.toFixed(2);
  }
  function addMonths(date, months) {
    const d = new Date(date);
    const day = d.getDate();
    d.setMonth(d.getMonth() + months);
    // handle month overflow
    if (d.getDate() !== day) {
      d.setDate(0);
    }
    return d;
  }
  function formatFullDate(d) {
    const opts = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(d).toLocaleDateString(undefined, opts);
  }

  // ------- Page state -------
  const productData = JSON.parse(localStorage.getItem("selectedProduct"));
  const storedCreator = localStorage.getItem("active_creator_code"); // persisted creator code if any

  const durationButtonsContainer = document.getElementById("durationButtons");
  const durationContainer = document.getElementById("durationContainer");
  const totalElem = document.getElementById("totalPrice");
  const discountLine = document.getElementById("discountLine");
  const discountAmountElem = document.getElementById("discountAmount");
  const baseTimesElem = document.getElementById("baseTimes");
  const summaryPriceElem = document.getElementById("summaryPrice");
  const productPriceElem = document.getElementById("productPrice");
  const planNameElem = document.getElementById("planName");
  const planDescElem = document.getElementById("planDescription");
  const nextBillingDisplay = document.getElementById("nextBillingDisplay");
  const codeInput = document.getElementById("creatorCode");
  const codeMsg = document.getElementById("codeMessage");

  let basePrice = 0;
  let selectedDuration = 1;
  let creatorDiscountActive = false;

  // If creator code was active previously, prefill and apply
  if (storedCreator) {
    codeInput.value = storedCreator;
    creatorDiscountActive = storedCreator.toLowerCase() === 'earlpom';
    if (creatorDiscountActive) {
      codeMsg.textContent = "âœ… Creator code active.";
      codeMsg.classList.add('text-success');
    }
  }

  // If no selected product: fallback to Basic (you can change behavior as needed)
  if (!productData) {
    planNameElem.textContent = 'Basic';
    planDescElem.textContent = 'Free/basic plan';
    productPriceElem.textContent = 'â‚±0.00';
    summaryPriceElem.textContent = 'â‚±0.00';
    totalElem.textContent = 'â‚±0.00';
    // nothing else to do for duration
  } else {
    // Populate product details
    planNameElem.textContent = productData.name;
    summaryPriceElem.textContent = `â‚±${parseFloat(productData.price).toFixed(2)}`;
    productPriceElem.textContent = `â‚±${parseFloat(productData.price).toFixed(2)} / month`;
    basePrice = parseFloat(productData.price);

    // Description -> bullet list if provided
    if (productData.description) {
      const features = productData.description.split(',').map(s => s.trim());
      planDescElem.innerHTML = "<ul class='mb-1 ps-3'>" + features.map(f => `<li>${f}</li>`).join('') + "</ul>";
    }

    // If it's premium item, show duration buttons
    if (productData.name.toLowerCase().includes('premium')) {
      durationContainer.classList.remove('d-none');

      // create duration buttons: 1,3,6,12 months
      const durations = [1,3,6,12];
      durations.forEach(months => {
        const durationBtn = document.createElement('button');
        durationBtn.type = 'button';
        durationBtn.className = 'duration-btn';
        // compute price with duration discount (5% off total) for >1 month
        const durDiscountMultiplier = months > 1 ? 0.95 : 1;
        const durPrice = basePrice * months * durDiscountMultiplier;
        // show -5% text for months>1
        const label = months === 1
          ? `${months} Month ${formatCurrency(basePrice)}`
          : `${months} Months ${formatCurrency(durPrice)}  (-5%)`;
        durationBtn.innerHTML = label;
        if (months === 1) durationBtn.classList.add('active');

        durationBtn.addEventListener('click', () => {
          document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('active'));
          durationBtn.classList.add('active');
          selectedDuration = months;
          updateSummary();
        });
        durationButtonsContainer.appendChild(durationBtn);
      });
    } else {
      // For coins / other products, prefill total
      totalElem.textContent = formatCurrency(basePrice);
      // Hide baseTimes
      baseTimesElem.style.display = 'none';
    }
  }

  // Apply Code button behavior
  document.getElementById('applyCodeBtn').addEventListener('click', () => {
    const code = codeInput.value.trim();
    codeMsg.classList.remove('text-success','text-danger');
    if (!code) {
      creatorDiscountActive = false;
      localStorage.removeItem('active_creator_code');
      codeMsg.textContent = '';
      updateSummary();
      return;
    }
    if (code.toLowerCase() === 'earlpom') {
      creatorDiscountActive = true;
      localStorage.setItem('active_creator_code', code);
      codeMsg.textContent = 'âœ… Code applied â€” 20% off.';
      codeMsg.classList.add('text-success');
      updateSummary();
    } else {
      creatorDiscountActive = false;
      localStorage.removeItem('active_creator_code');
      codeMsg.textContent = 'âŒ Invalid code.';
      codeMsg.classList.add('text-danger');
      updateSummary();
    }
  });

  // update summary (base x months, discounts, total, next billing)
  function updateSummary() {
    if (!productData) return;

    // compute base x months
    const baseTotal = basePrice * selectedDuration;
    baseTimesElem.style.display = (selectedDuration > 1) ? 'block' : 'none';
    baseTimesElem.textContent = `${formatCurrency(basePrice)} x ${selectedDuration} month${selectedDuration>1? 's':''} = ${formatCurrency(baseTotal)}`;

    // duration discount (5% off of baseTotal) for >1 month
    const durDiscount = selectedDuration > 1 ? baseTotal * 0.05 : 0;
    // price after duration discount
    let afterDur = baseTotal - durDiscount;

    // creator discount (20%) applied after duration discount (per previous behavior)
    const creatorDisc = creatorDiscountActive ? afterDur * 0.20 : 0;
    let finalTotal = afterDur - creatorDisc;

    // Build discount display lines (both if applicable)
    const discounts = [];
    if (durDiscount > 0) discounts.push(`Duration 5%: -${formatCurrency(durDiscount)}`);
    if (creatorDisc > 0) discounts.push(`Creator 20%: -${formatCurrency(creatorDisc)}`);

    if (discounts.length) {
      discountLine.classList.remove('d-none');
      discountAmountElem.textContent = discounts.join(' , ');
    } else {
      discountLine.classList.add('d-none');
    }

    totalElem.textContent = formatCurrency(finalTotal);

    // Next billing display (today + selectedDuration months)
    const nextBilling = addMonths(new Date(), selectedDuration);
    nextBillingDisplay.textContent = `Next Billing: ${formatFullDate(nextBilling)}`;
  }

  // initial summary update (also re-apply creator if persisted)
  if (storedCreator && storedCreator.toLowerCase() === 'earlpom') {
    creatorDiscountActive = true;
    codeMsg.textContent = 'âœ… Creator code active.';
    codeMsg.classList.add('text-success');
  }
  updateSummary();

  // Complete purchase
  document.getElementById('completePurchaseBtn').addEventListener('click', () => {
    if (!productData) return;

    const nameLower = productData.name.toLowerCase();
    if (nameLower.includes('premium')) {
      // Save plan, duration and next billing date
      const nextBilling = addMonths(new Date(), selectedDuration);
      localStorage.setItem('pomify_plan', productData.name);
      localStorage.setItem('pomify_plan_duration', selectedDuration.toString());
      localStorage.setItem('pomify_plan_date', new Date(nextBilling).toString());
      alert(`ðŸŽ‰ Subscribed to ${productData.name} for ${selectedDuration} month(s).\nNext billing: ${formatFullDate(nextBilling)}`);
    } else if (nameLower.includes('coin')) {
      // coin purchase: parse coin count from name like "10 Coins"
      const coinCount = parseInt(productData.name);
      let currentCoins = parseInt(localStorage.getItem('pomify_coins')) || 0;
      currentCoins += (isNaN(coinCount) ? 0 : coinCount);
      localStorage.setItem('pomify_coins', currentCoins.toString());
      alert(`ðŸ’° You received ${(isNaN(coinCount) ? 0 : coinCount)} coins! Total: ${currentCoins}`);
    }

    // redirect to shop after purchase
    window.location.href = 'Shop.html';
  });

  // Go back link
  document.getElementById('goBackBtn').addEventListener('click', () => {
    window.location.href = 'Shop.html';
  });
</script>

</body>
</html>
